name: On-Demand Automated Payments

on:
  workflow_dispatch:

env:
  TZ: Europe/Madrid

jobs:
  run-on-demand:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: |
          npm ci
          npx playwright install --with-deps chromium

      - name: Read script configuration
        id: read_config
        run: |
          CONFIG=$(cat choose-script.json)
          echo "Configuration loaded:"
          echo "$CONFIG"
          
          CASAORTEGA_ENABLED=$(echo "$CONFIG" | jq -r '.scripts.casaortega.enabled')
          CASAORTEGA_PATH=$(echo "$CONFIG" | jq -r '.scripts.casaortega.path')
          CASAORTEGA_NAME=$(echo "$CONFIG" | jq -r '.scripts.casaortega.name')
          
          HUERTAACASA_ENABLED=$(echo "$CONFIG" | jq -r '.scripts.huertaacasa.enabled')
          HUERTAACASA_PATH=$(echo "$CONFIG" | jq -r '.scripts.huertaacasa.path')
          HUERTAACASA_NAME=$(echo "$CONFIG" | jq -r '.scripts.huertaacasa.name')
          
          echo "casaortega_enabled=$CASAORTEGA_ENABLED" >> $GITHUB_OUTPUT
          echo "casaortega_path=$CASAORTEGA_PATH" >> $GITHUB_OUTPUT
          echo "casaortega_name=$CASAORTEGA_NAME" >> $GITHUB_OUTPUT
          
          echo "huertaacasa_enabled=$HUERTAACASA_ENABLED" >> $GITHUB_OUTPUT
          echo "huertaacasa_path=$HUERTAACASA_PATH" >> $GITHUB_OUTPUT
          echo "huertaacasa_name=$HUERTAACASA_NAME" >> $GITHUB_OUTPUT

      - name: Run Casa Ortega script
        if: steps.read_config.outputs.casaortega_enabled == 'true'
        env:
          USER_EMAIL: ${{ secrets.USER_EMAIL }}
          USER_PASSWORD: ${{ secrets.USER_PASSWORD }}
          CARD_NUMBER: ${{ secrets.CARD_NUMBER }}
          CARD_EXPIRY: ${{ secrets.CARD_EXPIRY }}
          CARD_CVV: ${{ secrets.CARD_CVV }}
        run: |
          echo " Running Casa Ortega payment script..."
          npx playwright test ${{ steps.read_config.outputs.casaortega_path }} --project=chromium || exit_code=$?
          echo "CASAORTEGA_EXIT_CODE=${exit_code:-0}" >> $GITHUB_ENV
          exit 0

      - name: Run Huerta a Casa script
        if: steps.read_config.outputs.huertaacasa_enabled == 'true'
        env:
          USER_EMAIL: ${{ secrets.USER_EMAIL }}
          USER_PASSWORD: ${{ secrets.USER_PASSWORD }}
          CARD_NUMBER: ${{ secrets.CARD_NUMBER }}
          CARD_EXPIRY: ${{ secrets.CARD_EXPIRY }}
          CARD_CVV: ${{ secrets.CARD_CVV }}
        run: |
          echo " Running Huerta a Casa payment script..."
          npx playwright test ${{ steps.read_config.outputs.huertaacasa_path }} --project=chromium || exit_code=$?
          echo "HUERTAACASA_EXIT_CODE=${exit_code:-0}" >> $GITHUB_ENV
          exit 0

      - name: Analyze Casa Ortega results
        if: steps.read_config.outputs.casaortega_enabled == 'true'
        id: analyze_casaortega
        run: |
          if [ "${CASAORTEGA_EXIT_CODE}" -eq 0 ]; then
            if grep -qir "OPERACIÓN AUTORIZADA CON CÓDIGO:" test-results/ playwright-report/ 2>/dev/null; then
              echo "status= SUCCESS" >> $GITHUB_OUTPUT
              echo "message=Transaction completed successfully" >> $GITHUB_OUTPUT
              echo "should_send_files=false" >> $GITHUB_OUTPUT
            else
              echo "status= UNKNOWN" >> $GITHUB_OUTPUT
              echo "message=Test passed but no success confirmation found" >> $GITHUB_OUTPUT
              echo "should_send_files=true" >> $GITHUB_OUTPUT
            fi
          else
            if grep -qir "Transacción denegada\." test-results/ playwright-report/ 2>/dev/null; then
              echo "status= DENIED" >> $GITHUB_OUTPUT
              echo "message=Transaction was denied by the bank" >> $GITHUB_OUTPUT
              echo "should_send_files=false" >> $GITHUB_OUTPUT
            else
              echo "status= ERROR" >> $GITHUB_OUTPUT
              echo "message=Technical error occurred during execution" >> $GITHUB_OUTPUT
              echo "should_send_files=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Analyze Huerta a Casa results
        if: steps.read_config.outputs.huertaacasa_enabled == 'true'
        id: analyze_huertaacasa
        run: |
          if [ "${HUERTAACASA_EXIT_CODE}" -eq 0 ]; then
            if grep -qir "OPERACIÓN AUTORIZADA CON CÓDIGO:" test-results/ playwright-report/ 2>/dev/null; then
              echo "status= SUCCESS" >> $GITHUB_OUTPUT
              echo "message=Transaction completed successfully" >> $GITHUB_OUTPUT
              echo "should_send_files=false" >> $GITHUB_OUTPUT
            else
              echo "status= UNKNOWN" >> $GITHUB_OUTPUT
              echo "message=Test passed but no success confirmation found" >> $GITHUB_OUTPUT
              echo "should_send_files=true" >> $GITHUB_OUTPUT
            fi
          else
            if grep -qir "Transacción denegada\." test-results/ playwright-report/ 2>/dev/null; then
              echo "status= DENIED" >> $GITHUB_OUTPUT
              echo "message=Transaction was denied by the bank" >> $GITHUB_OUTPUT
              echo "should_send_files=false" >> $GITHUB_OUTPUT
            else
              echo "status= ERROR" >> $GITHUB_OUTPUT
              echo "message=Technical error occurred during execution" >> $GITHUB_OUTPUT
              echo "should_send_files=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Prepare artifacts Casa Ortega
        if: |
          steps.read_config.outputs.casaortega_enabled == 'true' &&
          steps.analyze_casaortega.outputs.should_send_files == 'true'
        run: |
          mkdir -p artifacts/casaortega
          [ -d "test-results" ] && cp -r test-results artifacts/casaortega/ || echo "No test-results"
          [ -d "playwright-report" ] && cp -r playwright-report artifacts/casaortega/ || echo "No report"
          cd artifacts/casaortega
          zip -r ../casaortega-results.zip . || echo "Zip failed"

      - name: Prepare artifacts Huerta a Casa
        if: |
          steps.read_config.outputs.huertaacasa_enabled == 'true' &&
          steps.analyze_huertaacasa.outputs.should_send_files == 'true'
        run: |
          mkdir -p artifacts/huertaacasa
          [ -d "test-results" ] && cp -r test-results artifacts/huertaacasa/ || echo "No test-results"
          [ -d "playwright-report" ] && cp -r playwright-report artifacts/huertaacasa/ || echo "No report"
          cd artifacts/huertaacasa
          zip -r ../huertaacasa-results.zip . || echo "Zip failed"

      - name: Send Casa Ortega notification
        if: steps.read_config.outputs.casaortega_enabled == 'true'
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          STATUS="${{ steps.analyze_casaortega.outputs.status }}"
          MESSAGE="${{ steps.analyze_casaortega.outputs.message }}"
          SHOULD_SEND_FILES="${{ steps.analyze_casaortega.outputs.should_send_files }}"
          
          TELEGRAM_MESSAGE=" *${{ steps.read_config.outputs.casaortega_name }} - ON DEMAND*%0A%0A${STATUS}%0A${MESSAGE}%0A%0A $(TZ=Europe/Madrid date '+%Y-%m-%d %H:%M:%S %Z')"
          
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="${TELEGRAM_MESSAGE}" \
            -d parse_mode="Markdown"
          
          if [ "$SHOULD_SEND_FILES" = "true" ] && [ -f "artifacts/casaortega-results.zip" ]; then
            echo " Sending Casa Ortega files..."
            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
              -F chat_id="${CHAT_ID}" \
              -F document=@artifacts/casaortega-results.zip \
              -F caption="Casa Ortega test results"
          fi

      - name: Send Huerta a Casa notification
        if: steps.read_config.outputs.huertaacasa_enabled == 'true'
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          STATUS="${{ steps.analyze_huertaacasa.outputs.status }}"
          MESSAGE="${{ steps.analyze_huertaacasa.outputs.message }}"
          SHOULD_SEND_FILES="${{ steps.analyze_huertaacasa.outputs.should_send_files }}"
          
          TELEGRAM_MESSAGE=" *${{ steps.read_config.outputs.huertaacasa_name }} - ON DEMAND*%0A%0A${STATUS}%0A${MESSAGE}%0A%0A $(TZ=Europe/Madrid date '+%Y-%m-%d %H:%M:%S %Z')"
          
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="${TELEGRAM_MESSAGE}" \
            -d parse_mode="Markdown"
          
          if [ "$SHOULD_SEND_FILES" = "true" ] && [ -f "artifacts/huertaacasa-results.zip" ]; then
            echo " Sending Huerta a Casa files..."
            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
              -F chat_id="${CHAT_ID}" \
              -F document=@artifacts/huertaacasa-results.zip \
              -F caption="Huerta a Casa test results"
          fi

      - name: Final status
        run: |
          echo "=== Execution Summary ==="
          if [ "${{ steps.read_config.outputs.casaortega_enabled }}" = "true" ]; then
            echo "Casa Ortega: ${{ steps.analyze_casaortega.outputs.status }}"
          fi
          if [ "${{ steps.read_config.outputs.huertaacasa_enabled }}" = "true" ]; then
            echo "Huerta a Casa: ${{ steps.analyze_huertaacasa.outputs.status }}"
          fi
