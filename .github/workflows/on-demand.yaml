name: On-Demand Automated Paymentsname: On-Demand Execution



on:on:

  workflow_dispatch: # Manual execution only  workflow_dispatch:



env:jobs:

  TZ: Europe/Madrid  run-on-demand:

    runs-on: ubuntu-latest

jobs:    steps:

  automated-payments:      - name: Checkout repository

    runs-on: ubuntu-latest        uses: actions/checkout@v4

    timeout-minutes: 15

      - name: Setup Node.js

    steps:        uses: actions/setup-node@v4

      - name: üì• Checkout repository        with:

        uses: actions/checkout@v4          node-version: 18



      - name: üîß Setup Node.js      - name: Install dependencies

        uses: actions/setup-node@v4        run: |

        with:          npm ci

          node-version: '18'          npx playwright install --with-deps



      - name: üì¶ Install dependencies      - name: Run Playwright script

        run: npm ci        run: |

          npx playwright test scripts/casaortega.spec.ts --project=chromium --reporter=html,list || true

      - name: üé≠ Install Playwright browsers          echo "Test execution completed, checking results..."

        run: npx playwright install chromium          ls -la test-results/ || echo "No test-results directory found"

          ls -la playwright-report/ || echo "No playwright-report directory found"

      - name: üìñ Read script configuration        env:

        id: read_config          USER_EMAIL: ${{ secrets.USER_EMAIL }}

        run: |          USER_PASSWORD: ${{ secrets.USER_PASSWORD }}

          CONFIG=$(cat choose-script.json)          CARD_NUMBER: ${{ secrets.CARD_NUMBER }}

          echo "Configuration loaded:"          CARD_EXPIRY: ${{ secrets.CARD_EXPIRY }}

          echo "$CONFIG"          CARD_CVV: ${{ secrets.CARD_CVV }}

          

          # Extract enabled scripts      - name: Show test output for debugging

          CASAORTEGA_ENABLED=$(echo "$CONFIG" | jq -r '.scripts.casaortega.enabled')        if: always()

          CASAORTEGA_PATH=$(echo "$CONFIG" | jq -r '.scripts.casaortega.path')        run: |

          CASAORTEGA_NAME=$(echo "$CONFIG" | jq -r '.scripts.casaortega.name')          echo "=== Checking for screenshots and debug files ==="

                    ls -la *.png || echo "No PNG files found in root"

          HUERTAACASA_ENABLED=$(echo "$CONFIG" | jq -r '.scripts.huertaacasa.enabled')          echo "=== Checking test-results directory ==="

          HUERTAACASA_PATH=$(echo "$CONFIG" | jq -r '.scripts.huertaacasa.path')          find test-results -name "*.png" -o -name "*.webm" -o -name "*.md" 2>/dev/null || echo "No test-results directory or files"

          HUERTAACASA_NAME=$(echo "$CONFIG" | jq -r '.scripts.huertaacasa.name')          echo "=== Checking for HTML report ==="

                    find playwright-report -name "*.html" 2>/dev/null || echo "No HTML report found"

          echo "casaortega_enabled=$CASAORTEGA_ENABLED" >> $GITHUB_OUTPUT          echo "=== Test execution summary ==="

          echo "casaortega_path=$CASAORTEGA_PATH" >> $GITHUB_OUTPUT          cat test-results/*/test-failed-*.png 2>/dev/null && echo "Screenshots found" || echo "No failure screenshots"

          echo "casaortega_name=$CASAORTEGA_NAME" >> $GITHUB_OUTPUT

                - name: Create artifacts for Telegram (Errors Only)

          echo "huertaacasa_enabled=$HUERTAACASA_ENABLED" >> $GITHUB_OUTPUT        if: always()

          echo "huertaacasa_path=$HUERTAACASA_PATH" >> $GITHUB_OUTPUT        run: |

          echo "huertaacasa_name=$HUERTAACASA_NAME" >> $GITHUB_OUTPUT          # Analizar el resultado ANTES de crear archivos

          echo "=== Analizando resultados para determinar si crear archivos ==="

      - name: üè¶ Run Casa Ortega script          

        if: steps.read_config.outputs.casaortega_enabled == 'true'          # Buscar indicadores de √©xito o denegaci√≥n (NO necesitan archivos de debugging)

        env:          if grep -qir "Transacci√≥n denegada\." test-results/ playwright-report/ 2>/dev/null; then

          USER_EMAIL: ${{ secrets.USER_EMAIL }}            echo "Transacci√≥n denegada detectada - NO se enviar√°n archivos (no es error t√©cnico)"

          USER_PASSWORD: ${{ secrets.USER_PASSWORD }}            echo "TELEGRAM_FILE_READY=false" >> $GITHUB_ENV

          CARD_NUMBER: ${{ secrets.CARD_NUMBER }}            echo "STATUS=‚ùå TRANSACCI√ìN DENEGADA" >> $GITHUB_ENV

          CARD_EXPIRY: ${{ secrets.CARD_EXPIRY }}          elif grep -qi "OPERACI√ìN AUTORIZADA CON C√ìDIGO:" test-results/ playwright-report/ 2>/dev/null; then

          CARD_CVV: ${{ secrets.CARD_CVV }}            echo "Transacci√≥n exitosa detectada - NO se enviar√°n archivos (funcionamiento normal)"

        run: |            echo "TELEGRAM_FILE_READY=false" >> $GITHUB_ENV

          echo "üè¶ Running Casa Ortega payment script..."            echo "STATUS=‚úÖ √âXITO" >> $GITHUB_ENV

          npx playwright test ${{ steps.read_config.outputs.casaortega_path }} || exit_code=$?          # Solo crear archivos para errores t√©cnicos o estados desconocidos (problemas del workflow)

          echo "CASAORTEGA_EXIT_CODE=${exit_code:-0}" >> $GITHUB_ENV          else

          exit 0            echo "Error t√©cnico o estado desconocido - S√ç se enviar√°n archivos para debugging t√©cnico"

            if [ "${{ job.status }}" == "failure" ]; then

      - name: üå± Run Huerta a Casa script              echo "STATUS=‚ùå ERROR T√âCNICO" >> $GITHUB_ENV

        if: steps.read_config.outputs.huertaacasa_enabled == 'true'            else

        env:              echo "STATUS=‚ö†Ô∏è ESTADO DESCONOCIDO" >> $GITHUB_ENV

          USER_EMAIL: ${{ secrets.USER_EMAIL }}            fi

          USER_PASSWORD: ${{ secrets.USER_PASSWORD }}            

          CARD_NUMBER: ${{ secrets.CARD_NUMBER }}            if [ -d "test-results" ] || [ -f "*.png" ] || [ -d "playwright-report" ]; then

          CARD_EXPIRY: ${{ secrets.CARD_EXPIRY }}              echo "Creando archivo ZIP para debugging..."

          CARD_CVV: ${{ secrets.CARD_CVV }}              zip -r telegram-artifacts.zip test-results/ *.png playwright-report/ 2>/dev/null || true

        run: |              

          echo "üå± Running Huerta a Casa payment script..."              if [ -f "telegram-artifacts.zip" ]; then

          npx playwright test ${{ steps.read_config.outputs.huertaacasa_path }} || exit_code=$?                FILE_SIZE=$(stat -c%s "telegram-artifacts.zip" 2>/dev/null || stat -f%z "telegram-artifacts.zip" 2>/dev/null || echo "0")

          echo "HUERTAACASA_EXIT_CODE=${exit_code:-0}" >> $GITHUB_ENV                echo "Archivo ZIP creado: ${FILE_SIZE} bytes"

          exit 0                if [ "${FILE_SIZE}" -gt 52428800 ]; then

                  echo "Archivo muy grande (>50MB), creando versi√≥n reducida..."

      - name: üìä Analyze Casa Ortega results                  zip -r telegram-artifacts-reduced.zip test-results/*.png playwright-report/index.html 2>/dev/null || true

        if: steps.read_config.outputs.casaortega_enabled == 'true'                  mv telegram-artifacts-reduced.zip telegram-artifacts.zip 2>/dev/null || true

        id: analyze_casaortega                fi

        run: |                echo "TELEGRAM_FILE_READY=true" >> $GITHUB_ENV

          if [ "${CASAORTEGA_EXIT_CODE}" -eq 0 ]; then              else

            if grep -q "OPERACI√ìN AUTORIZADA CON C√ìDIGO:" playwright-report/index.html 2>/dev/null || \                echo "TELEGRAM_FILE_READY=false" >> $GITHUB_ENV

               grep -q "Pago realizado correctamente" test-results/**/*.txt 2>/dev/null; then              fi

              echo "status=‚úÖ SUCCESS" >> $GITHUB_OUTPUT            else

              echo "message=Transaction completed successfully" >> $GITHUB_OUTPUT              echo "No hay archivos de debugging disponibles"

              echo "should_send_files=false" >> $GITHUB_OUTPUT              echo "TELEGRAM_FILE_READY=false" >> $GITHUB_ENV

            else            fi

              echo "status=‚ùì UNKNOWN" >> $GITHUB_OUTPUT          fi

              echo "message=Test passed but no success confirmation found" >> $GITHUB_OUTPUT

              echo "should_send_files=true" >> $GITHUB_OUTPUT      - name: Send Telegram notification with files (errors only)

            fi        if: always()

          else        run: |

            if grep -q "Transacci√≥n denegada." test-results/**/*.txt 2>/dev/null || \          # Usar el estado ya determinado en el paso anterior

               grep -q "Payment was denied" test-results/**/*.txt 2>/dev/null; then          case "$STATUS" in

              echo "status=‚ùå DENIED" >> $GITHUB_OUTPUT            "‚úÖ √âXITO")

              echo "message=Transaction was denied by the bank" >> $GITHUB_OUTPUT              MESSAGE="üéâ El dep√≥sito autom√°tico de Casa Ortega (MANUAL) se realiz√≥ correctamente!"

              echo "should_send_files=false" >> $GITHUB_OUTPUT              ;;

            else            "‚ùå TRANSACCI√ìN DENEGADA")

              echo "status=üí• ERROR" >> $GITHUB_OUTPUT              MESSAGE="üí≥ La transacci√≥n fue denegada por el procesador de pagos (MANUAL)."

              echo "message=Technical error occurred during execution" >> $GITHUB_OUTPUT              ;;

              echo "should_send_files=true" >> $GITHUB_OUTPUT            "‚ùå ERROR T√âCNICO")

            fi              MESSAGE="‚ö†Ô∏è Error t√©cnico en la ejecuci√≥n del workflow manual. Revisa los logs."

          fi              ;;

            "‚ö†Ô∏è ESTADO DESCONOCIDO")

      - name: üìä Analyze Huerta a Casa results              MESSAGE="üîç No se pudo determinar el resultado de la transacci√≥n manual. Revisa el reporte."

        if: steps.read_config.outputs.huertaacasa_enabled == 'true'              ;;

        id: analyze_huertaacasa            *)

        run: |              STATUS="‚ö†Ô∏è ESTADO DESCONOCIDO"

          if [ "${HUERTAACASA_EXIT_CODE}" -eq 0 ]; then              MESSAGE="üîç No se pudo determinar el resultado de la transacci√≥n manual. Revisa el reporte."

            if grep -q "OPERACI√ìN AUTORIZADA CON C√ìDIGO:" playwright-report/index.html 2>/dev/null || \              ;;

               grep -q "Pago realizado correctamente" test-results/**/*.txt 2>/dev/null; then          esac

              echo "status=‚úÖ SUCCESS" >> $GITHUB_OUTPUT          

              echo "message=Transaction completed successfully" >> $GITHUB_OUTPUT          # Preparar mensaje base

              echo "should_send_files=false" >> $GITHUB_OUTPUT          FULL_MESSAGE="üè¶ *CASA ORTEGA - ON DEMAND*

            else          

              echo "status=‚ùì UNKNOWN" >> $GITHUB_OUTPUT          $STATUS: $MESSAGE

              echo "message=Test passed but no success confirmation found" >> $GITHUB_OUTPUT          

              echo "should_send_files=true" >> $GITHUB_OUTPUT          Fecha: $(date '+%d/%m/%Y %H:%M')

            fi          Ver detalles: https://github.com/LiReXz/automated-payments/actions/runs/${{ github.run_id }}"

          else          

            if grep -q "Transacci√≥n denegada." test-results/**/*.txt 2>/dev/null || \          # Solo agregar informaci√≥n de archivos si es error t√©cnico o desconocido

               grep -q "Payment was denied" test-results/**/*.txt 2>/dev/null; then          if [ "$TELEGRAM_FILE_READY" = "true" ]; then

              echo "status=‚ùå DENIED" >> $GITHUB_OUTPUT            FULL_MESSAGE="${FULL_MESSAGE}

              echo "message=Transaction was denied by the bank" >> $GITHUB_OUTPUT            

              echo "should_send_files=false" >> $GITHUB_OUTPUT          ÔøΩ *Archivos de debugging adjuntos*

            else          ‚ö†Ô∏è *Solo se env√≠an archivos en casos de error para debugging*"

              echo "status=üí• ERROR" >> $GITHUB_OUTPUT          fi

              echo "message=Technical error occurred during execution" >> $GITHUB_OUTPUT

              echo "should_send_files=true" >> $GITHUB_OUTPUT          # Enviar mensaje de texto

            fi          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \

          fi            -d chat_id="${CHAT_ID}" \

            -d text="$FULL_MESSAGE" \

      - name: üì¶ Prepare artifacts (Casa Ortega)            -d parse_mode="Markdown"

        if: |          

          steps.read_config.outputs.casaortega_enabled == 'true' &&          # Enviar archivo solo si hay error t√©cnico o estado desconocido

          steps.analyze_casaortega.outputs.should_send_files == 'true'          if [ "$TELEGRAM_FILE_READY" = "true" ] && [ -f "telegram-artifacts.zip" ]; then

        run: |            echo "Enviando archivo de debugging por Telegram (solo para errores)..."

          mkdir -p artifacts/casaortega            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \

          [ -d "test-results" ] && cp -r test-results artifacts/casaortega/ || echo "No test-results found"              -F chat_id="${CHAT_ID}" \

          [ -d "playwright-report" ] && cp -r playwright-report artifacts/casaortega/ || echo "No playwright-report found"              -F document=@telegram-artifacts.zip \

          cd artifacts/casaortega              -F caption="ÔøΩ Archivos de debugging - Solo enviados en casos de error t√©cnico o estado desconocido"

          zip -r ../casaortega-results.zip . || echo "Zip creation failed"          fi

        env:

      - name: üì¶ Prepare artifacts (Huerta a Casa)          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}

        if: |          CHAT_ID: ${{ secrets.CHAT_ID }}

          steps.read_config.outputs.huertaacasa_enabled == 'true' &&
          steps.analyze_huertaacasa.outputs.should_send_files == 'true'
        run: |
          mkdir -p artifacts/huertaacasa
          [ -d "test-results" ] && cp -r test-results artifacts/huertaacasa/ || echo "No test-results found"
          [ -d "playwright-report" ] && cp -r playwright-report artifacts/huertaacasa/ || echo "No playwright-report found"
          cd artifacts/huertaacasa
          zip -r ../huertaacasa-results.zip . || echo "Zip creation failed"

      - name: üì§ Send Casa Ortega notification to Telegram
        if: steps.read_config.outputs.casaortega_enabled == 'true'
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          STATUS="${{ steps.analyze_casaortega.outputs.status }}"
          MESSAGE="${{ steps.analyze_casaortega.outputs.message }}"
          SHOULD_SEND_FILES="${{ steps.analyze_casaortega.outputs.should_send_files }}"
          
          TELEGRAM_MESSAGE="üè¶ *${{ steps.read_config.outputs.casaortega_name }} - ON DEMAND*%0A%0A${STATUS}%0A${MESSAGE}%0A%0Aüïê $(TZ=Europe/Madrid date '+%Y-%m-%d %H:%M:%S %Z')"
          
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="${TELEGRAM_MESSAGE}" \
            -d parse_mode="Markdown"
          
          if [ "$SHOULD_SEND_FILES" = "true" ] && [ -f "artifacts/casaortega-results.zip" ]; then
            echo "üìé Sending Casa Ortega files..."
            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
              -F chat_id="${CHAT_ID}" \
              -F document=@artifacts/casaortega-results.zip \
              -F caption="Casa Ortega test results and screenshots"
          fi

      - name: üì§ Send Huerta a Casa notification to Telegram
        if: steps.read_config.outputs.huertaacasa_enabled == 'true'
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          STATUS="${{ steps.analyze_huertaacasa.outputs.status }}"
          MESSAGE="${{ steps.analyze_huertaacasa.outputs.message }}"
          SHOULD_SEND_FILES="${{ steps.analyze_huertaacasa.outputs.should_send_files }}"
          
          TELEGRAM_MESSAGE="üå± *${{ steps.read_config.outputs.huertaacasa_name }} - ON DEMAND*%0A%0A${STATUS}%0A${MESSAGE}%0A%0Aüïê $(TZ=Europe/Madrid date '+%Y-%m-%d %H:%M:%S %Z')"
          
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="${TELEGRAM_MESSAGE}" \
            -d parse_mode="Markdown"
          
          if [ "$SHOULD_SEND_FILES" = "true" ] && [ -f "artifacts/huertaacasa-results.zip" ]; then
            echo "üìé Sending Huerta a Casa files..."
            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
              -F chat_id="${CHAT_ID}" \
              -F document=@artifacts/huertaacasa-results.zip \
              -F caption="Huerta a Casa test results and screenshots"
          fi

      - name: üîÑ Final status
        run: |
          echo "=== Execution Summary ==="
          if [ "${{ steps.read_config.outputs.casaortega_enabled }}" = "true" ]; then
            echo "Casa Ortega: ${{ steps.analyze_casaortega.outputs.status }}"
          fi
          if [ "${{ steps.read_config.outputs.huertaacasa_enabled }}" = "true" ]; then
            echo "Huerta a Casa: ${{ steps.analyze_huertaacasa.outputs.status }}"
          fi
